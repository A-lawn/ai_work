server:
  port: 8080

spring:
  application:
    name: gateway-service
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      routes:
        # 文档管理服务路由
        - id: document-service
          uri: lb://document-service
          predicates:
            - Path=/api/v1/documents/**
          filters:
            - StripPrefix=0
        
        # 会话管理服务路由
        - id: session-service
          uri: lb://session-service
          predicates:
            - Path=/api/v1/sessions/**
          filters:
            - StripPrefix=0
            - name: CircuitBreaker
              args:
                name: sessionServiceCircuitBreaker
                fallbackUri: forward:/fallback/session
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT
                methods: GET,POST,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 300ms
                  factor: 2
                  basedOnPreviousValue: false
        
        # 认证服务路由
        - id: auth-service
          uri: lb://auth-service
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=0
        
        # 配置管理服务路由
        - id: config-service
          uri: lb://config-service
          predicates:
            - Path=/api/v1/config/**
          filters:
            - StripPrefix=0
        
        # 监控服务路由
        - id: monitor-service
          uri: lb://monitor-service
          predicates:
            - Path=/api/v1/logs/**,/api/v1/metrics/**,/api/v1/stats/**
          filters:
            - StripPrefix=0
        
        # 直接查询服务路由（不通过会话，用于测试）
        - id: direct-query-service
          uri: lb://rag-query-service
          predicates:
            - Path=/api/direct/query
            - Method=POST
          filters:
            - RewritePath=/api/direct/query, /api/query
            - name: CircuitBreaker
              args:
                name: queryServiceCircuitBreaker
                fallbackUri: forward:/fallback/query
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT
                methods: POST
                backoff:
                  firstBackoff: 100ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
      
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            allowCredentials: false
      
      httpclient:
        connect-timeout: 5000
        response-timeout: 30s
        pool:
          type: elastic
          max-idle-time: 30s
          max-life-time: 60s
    
    sentinel:
      transport:
        dashboard: ${SENTINEL_DASHBOARD:localhost:8858}
        port: 8719
      datasource:
        flow:
          nacos:
            server-addr: ${NACOS_SERVER:localhost:8848}
            dataId: ${spring.application.name}-flow-rules
            groupId: SENTINEL_GROUP
            rule-type: flow
        degrade:
          nacos:
            server-addr: ${NACOS_SERVER:localhost:8848}
            dataId: ${spring.application.name}-degrade-rules
            groupId: SENTINEL_GROUP
            rule-type: degrade
        system:
          nacos:
            server-addr: ${NACOS_SERVER:localhost:8848}
            dataId: ${spring.application.name}-system-rules
            groupId: SENTINEL_GROUP
            rule-type: system
      eager: true
  
  sleuth:
    sampler:
      probability: 1.0
  
  zipkin:
    base-url: ${ZIPKIN_URL:http://localhost:9411}
    sender:
      type: web
  
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
    database: 0

management:
  endpoints:
    web:
      exposure:
        include: '*'
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true

logging:
  level:
    root: INFO
    com.rag.ops: DEBUG
    org.springframework.cloud.gateway: DEBUG
